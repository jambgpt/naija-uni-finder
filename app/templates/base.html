<!-- app/templates/base.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <meta
      name="description"
      content="Find the perfect educational institution in Nigeria - Compare universities, courses, and admission requirements"
    />
    <meta name="theme-color" content="var(--primary-color)" />

    <title>{% block title %}Naija Find Uni!{% endblock %}</title>

    <!-- Preload Critical Resources -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />

    <!-- Core Stylesheets -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <script>
      // Add this right after your CSS link
      document.addEventListener("DOMContentLoaded", function () {
        const style = getComputedStyle(document.querySelector(".navbar"));
        if (
          style.backgroundColor === "rgba(0, 0, 0, 0)" ||
          style.backgroundColor === "transparent"
        ) {
          console.error("Navbar styles not loading properly");
          // Fallback styles
          document.querySelector(".navbar").style.backgroundColor = "#2c3e50";
        }
      });
    </script>

    <!-- Custom Head Block -->
    {% block extra_head %}{% endblock %}

    <!-- Google Adsense -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1794093128763042"
      crossorigin="anonymous"
    ></script>
    <meta name="google-adsense-account" content="ca-pub-1794093128763042" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
      <div class="container">
        <a
          class="navbar-brand d-flex align-items-center"
          href="{{ url_for('main.home') }}"
        >
          <i class="fas fa-university me-2"></i>
          Naija Find Uni!
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a
                class="nav-link {% if request.endpoint == 'main.home' %}active{% endif %}"
                href="{{ url_for('main.home') }}"
              >
                <i class="fas fa-home me-1"></i>Home
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link {% if request.endpoint == 'main.about' %}active{% endif %}"
                href="{{ url_for('main.about') }}"
              >
                <i class="fas fa-info-circle me-1"></i>About
              </a>
            </li>
            <li class="nav-item position-relative">
              <a
                class="nav-link {% if request.endpoint == 'main.contact' %}active{% endif %}"
                href="{{ url_for('main.contact') }}"
              >
                <i class="fas fa-envelope me-1"></i>Contact
                <span class="notification-badge"></span>
              </a>
            </li>
          </ul>

          <!-- Global Search -->
          <form
            class="d-flex me-2"
            action="{{ url_for('main.search_results') }}"
            method="GET"
          >
            <div class="input-group">
              <input
                class="form-control"
                type="search"
                placeholder="Search institutions or courses..."
                name="q"
                aria-label="Search"
                autocomplete="off"
              />
              <button class="btn btn-outline-light" type="submit">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </form>

          <!-- Authentication Navigation -->
          <ul class="navbar-nav">
            {% if current_user.is_authenticated %}
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="userDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="fas fa-user-circle me-1"></i>
                {{ current_user.username }}
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="userDropdown"
              >
                <li>
                  <a
                    class="dropdown-item"
                    href="{{ url_for('main.profile', username=current_user.username) }}"
                  >
                    <i class="fas fa-user me-2"></i>Profile
                  </a>
                </li>
                {% if current_user.is_admin %}
                <li>
                  <a
                    class="dropdown-item"
                    href="{{ url_for('admin.admin_dashboard') }}"
                  >
                    <i class="fas fa-cog me-2"></i>Admin
                  </a>
                </li>
                {% endif %}
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                  </a>
                </li>
              </ul>
            </li>
            {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('auth.login') }}">
                <i class="fas fa-sign-in-alt me-1"></i>Login
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('auth.signup') }}">
                <i class="fas fa-user-plus me-1"></i>Sign Up
              </a>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ category }} alert-dismissible fade show"
        role="alert"
      >
        <div class="d-flex align-items-center">
          <i
            class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'danger' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} me-2"
          ></i>
          <div>{{ message }}</div>
        </div>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %} {% block content %}{% endblock %}
    </div>

    <!-- Footer -->
    <footer class="footer py-4 mt-5 bg-dark text-white">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5>Naija Find Uni!</h5>
            <p class="mb-0">
              Helping students find their perfect educational path in Nigeria.
            </p>
          </div>
          <div class="col-md-3">
            <h5>Quick Links</h5>
            <ul class="list-unstyled">
              <li>
                <a href="{{ url_for('main.home') }}" class="text-white"
                  ><i class="fas fa-home me-2"></i>Home</a
                >
              </li>
              <li>
                <a href="{{ url_for('main.about') }}" class="text-white"
                  ><i class="fas fa-info-circle me-2"></i>About</a
                >
              </li>
              <li>
                <a href="{{ url_for('main.contact') }}" class="text-white"
                  ><i class="fas fa-envelope me-2"></i>Contact</a
                >
              </li>
            </ul>
          </div>
          <div class="col-md-3">
            <h5>Follow Us</h5>
            <div class="social-links">
              <a
                href="https://www.facebook.com/9jaSL"
                class="text-white me-3"
                aria-label="Facebook"
              >
                <i class="fab fa-facebook-f"></i>
              </a>
              <a href="#" class="text-white me-3" aria-label="Twitter">
                <i class="fab fa-twitter"></i>
              </a>
              <a
                href="https://www.instagram.com/9jastudentlife"
                class="text-white me-3"
                aria-label="Instagram"
              >
                <i class="fab fa-instagram"></i>
              </a>
            </div>
          </div>
        </div>
        <hr class="mt-4 mb-3" />
        <p class="text-center mb-0">
          &copy; 2015 9jaStudentLife LTD. All rights reserved.
        </p>
      </div>
    </footer>

    <!-- Toast Container -->
    <div
      id="toastContainer"
      class="toast-container position-fixed top-0 end-0 p-3"
    ></div>

    <!-- Cookie Consent -->
    <div id="consent-banner" class="cookie-consent-banner">
      <div class="container">
        <div class="cookie-content">
          <p class="mb-3">
            We use cookies and similar technologies to improve your browsing
            experience, personalize content and ads, and analyze our traffic. By
            clicking "Accept All", you consent to our use of cookies.
          </p>
          <div class="cookie-buttons">
            <button class="btn btn-primary" onclick="acceptAllConsent()">
              <i class="fas fa-check"></i>
              Accept All
            </button>
            <button
              class="btn btn-outline-secondary"
              onclick="rejectAllConsent()"
            >
              <i class="fas fa-times"></i>
              Reject All
            </button>
            <button class="btn btn-link" onclick="managePreferences()">
              <i class="fas fa-cog"></i>
              Manage Preferences
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Cookie Preferences Modal -->
    <div
      id="preferences-modal"
      class="modal fade"
      tabindex="-1"
      aria-labelledby="preferencesModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="preferencesModalLabel">
              <i class="fas fa-cookie-bite me-2"></i>Cookie Preferences
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="form-check form-switch mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="personalizedAdsConsent"
                checked
              />
              <label class="form-check-label" for="personalizedAdsConsent"
                >Personalized Ads</label
              >
              <small class="form-text text-muted d-block">
                When enabled, we use cookies to personalize ads based on your
                interests and browsing activity.
              </small>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times me-2"></i>Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="savePreferences()"
            >
              <i class="fas fa-save me-2"></i>Save changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Core Scripts -->
    <script>
      window.csrfToken = "{{ csrf_token() }}";
      window.isAuthenticated = {{ current_user.is_authenticated|tojson }};
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- Refactored Custom Scripts -->
    <script src="{{ url_for('static', filename='js/state.js') }}"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/comments.js') }}"></script>
    <script src="{{ url_for('static', filename='js/voting.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bookmarks.js') }}"></script>
    <script src="{{ url_for('static', filename='js/institutionModal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/courseSearch.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <!-- Cookie Consent Script -->
    <script>
      // Cookie Consent Management
      const CookieConsent = {
        init() {
          // Only show banner if consent hasn't been given
          if (!this.hasConsent()) {
            this.showBanner();
          }
          this.attachEventListeners();
        },

        hasConsent() {
          return localStorage.getItem("cookieConsent") !== null;
        },

        showBanner() {
          const banner = document.getElementById("consent-banner");
          if (banner) {
            banner.style.display = "block";
          }
        },

        hideBanner() {
          const banner = document.getElementById("consent-banner");
          if (banner) {
            banner.style.display = "none";
          }
        },

        saveConsent(type, preferences = {}) {
          localStorage.setItem("cookieConsent", type);
          localStorage.setItem(
            "cookiePreferences",
            JSON.stringify(preferences)
          );
          localStorage.setItem("consentTimestamp", new Date().toISOString());
          this.hideBanner();
        },

        attachEventListeners() {
          // Accept All
          const acceptBtn = document.querySelector(
            '[onclick="acceptAllConsent()"]'
          );
          if (acceptBtn) {
            acceptBtn.addEventListener("click", (e) => {
              e.preventDefault();
              this.saveConsent("full", { analytics: true, advertising: true });
              this.applyPreferences({ analytics: true, advertising: true });
            });
          }

          // Reject All
          const rejectBtn = document.querySelector(
            '[onclick="rejectAllConsent()"]'
          );
          if (rejectBtn) {
            rejectBtn.addEventListener("click", (e) => {
              e.preventDefault();
              this.saveConsent("minimal", {
                analytics: false,
                advertising: false,
              });
              this.applyPreferences({ analytics: false, advertising: false });
            });
          }

          // Manage Preferences
          const manageBtn = document.querySelector(
            '[onclick="managePreferences()"]'
          );
          if (manageBtn) {
            manageBtn.addEventListener("click", (e) => {
              e.preventDefault();
              this.showPreferencesModal();
            });
          }
        },

        applyPreferences(preferences) {
          if (preferences.advertising) {
            // Enable personalized ads
            window.googletag = window.googletag || { cmd: [] };
            googletag.cmd.push(() => {
              googletag.pubads().setRequestNonPersonalizedAds(0);
            });
          } else {
            // Disable personalized ads
            window.googletag = window.googletag || { cmd: [] };
            googletag.cmd.push(() => {
              googletag.pubads().setRequestNonPersonalizedAds(1);
            });
          }

          // Apply other preferences as needed
        },

        showPreferencesModal() {
          const modal = new bootstrap.Modal(
            document.getElementById("preferences-modal")
          );
          const savedPreferences = JSON.parse(
            localStorage.getItem("cookiePreferences") || "{}"
          );

          // Update checkbox states
          const checkboxes = document.querySelectorAll(
            '#preferences-modal input[type="checkbox"]'
          );
          checkboxes.forEach((checkbox) => {
            checkbox.checked = savedPreferences[checkbox.id] || false;
          });

          modal.show();
        },
      };

      // Initialize on DOM load
      document.addEventListener("DOMContentLoaded", () => {
        CookieConsent.init();
      });

      // Make functions available globally
      window.acceptAllConsent = () =>
        CookieConsent.saveConsent("full", {
          analytics: true,
          advertising: true,
        });
      window.rejectAllConsent = () =>
        CookieConsent.saveConsent("minimal", {
          analytics: false,
          advertising: false,
        });
      window.managePreferences = () => CookieConsent.showPreferencesModal();
      window.savePreferences = () => {
        const preferences = {
          analytics:
            document.getElementById("analyticsConsent")?.checked || false,
          advertising:
            document.getElementById("personalizedAdsConsent")?.checked || false,
        };
        CookieConsent.saveConsent("custom", preferences);
        CookieConsent.applyPreferences(preferences);
        bootstrap.Modal.getInstance(
          document.getElementById("preferences-modal")
        ).hide();
      };
    </script>

    <!-- Utility Scripts -->
    <script>
      // Initialize Bootstrap tooltips
      document.addEventListener("DOMContentLoaded", function () {
        var tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
          new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });

      // Handle navigation active states
      document.addEventListener("DOMContentLoaded", function () {
        const currentPath = window.location.pathname;
        document.querySelectorAll(".nav-link").forEach((link) => {
          if (link.getAttribute("href") === currentPath) {
            link.classList.add("active");
          }
        });
      });

      // Smooth scroll behavior
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
          anchor.addEventListener("click", function (e) {
            const href = this.getAttribute("href");
            if (href === "#" || href === "") {
              // Prevent default action for href="#" or empty href
              e.preventDefault();
            } else {
              e.preventDefault();
              try {
                const target = document.querySelector(href);
                if (target) {
                  target.scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                  });
                }
              } catch (error) {
                console.error(`Invalid selector '${href}'`, error);
              }
            }
          });
        });
      });

      // Handle mobile navigation
      document.addEventListener("DOMContentLoaded", function () {
        const navbarToggler = document.querySelector(".navbar-toggler");
        const navbarCollapse = document.querySelector(".navbar-collapse");

        if (navbarToggler && navbarCollapse) {
          document.addEventListener("click", function (e) {
            if (
              !navbarCollapse.contains(e.target) &&
              !navbarToggler.contains(e.target)
            ) {
              if (navbarCollapse.classList.contains("show")) {
                navbarToggler.click();
              }
            }
          });

          // Close mobile menu when link is clicked, except for dropdown toggles
          navbarCollapse
            .querySelectorAll(".nav-link:not(.dropdown-toggle)")
            .forEach((link) => {
              link.addEventListener("click", () => {
                if (navbarCollapse.classList.contains("show")) {
                  navbarToggler.click();
                }
              });
            });
        }
      });

      // Handle scroll to top
      document.addEventListener("DOMContentLoaded", function () {
        const scrollTopBtn = document.createElement("button");
        scrollTopBtn.className = "scroll-top-btn";
        scrollTopBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
        document.body.appendChild(scrollTopBtn);

        window.addEventListener("scroll", function () {
          if (window.pageYOffset > 100) {
            scrollTopBtn.classList.add("show");
          } else {
            scrollTopBtn.classList.remove("show");
          }
        });

        scrollTopBtn.addEventListener("click", function () {
          window.scrollTo({
            top: 0,
            behavior: "smooth",
          });
        });
      });

      // Enhanced form validation
      document.addEventListener("DOMContentLoaded", function () {
        const forms = document.querySelectorAll("form");
        forms.forEach((form) => {
          if (form.classList.contains("needs-validation")) {
            form.addEventListener(
              "submit",
              function (event) {
                if (!form.checkValidity()) {
                  event.preventDefault();
                  event.stopPropagation();
                }
                form.classList.add("was-validated");
              },
              false
            );
          }
        });
      });

      // Handle dynamic year in footer
      document.addEventListener("DOMContentLoaded", function () {
        const yearElement = document.querySelector(".copyright-year");
        if (yearElement) {
          yearElement.textContent = new Date().getFullYear();
        }
      });
    </script>

    <!-- Custom Scripts Block -->
    {% block extra_scripts %}{% endblock %}
  </body>
</html>
