<!-- app/templates/home.html -->
{% extends "base.html" %} {% block title %}Home - Naija! Find Uni{% endblock %}
{% block extra_head %}
<style>
  .hero-section {
    min-height: 100vh;
    background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)),
      url("/static/images/hero.png");
    background-size: cover;
    background-position: center;
    background-attachment: fixed; /* Change from dynamic to fixed */
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    padding: 3rem 0;
  }

  @media (prefers-reduced-motion: reduce) {
    .hero-section {
      background-attachment: scroll !important;
    }
  }

  .hero-content {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInUp 1s ease forwards;
  }

  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .wizard-step {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transform: translateY(20px);
    opacity: 0;
    transition: all 0.5s ease;
    display: none;
  }

  .wizard-step.active {
    transform: translateY(0);
    opacity: 1;
    display: block;
  }
  .institution-type-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .institution-card {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    text-align: center;
    position: relative;
  }

  .institution-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border-color: #3498db;
  }

  .institution-card.selected {
    background: rgba(52, 152, 219, 0.1);
    border-color: #3498db;
    color: #2c3e50;
  }

  .institution-card.selected i {
    color: #3498db;
  }

  .institution-card.selected::after {
    content: "\f00c";
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    position: absolute;
    top: 10px;
    right: 10px;
    color: #3498db;
  }

  .scroll-prompt {
    position: absolute;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    opacity: 0.8;
    animation: bounce 2s infinite;
    pointer-events: none;
  }

  @keyframes bounce {
    0%,
    20%,
    50%,
    80%,
    100% {
      transform: translateX(-50%) translateY(0);
    }
    40% {
      transform: translateX(-50%) translateY(-10px);
    }
    60% {
      transform: translateX(-50%) translateY(-5px);
    }
  }

  .form-select {
    background-color: white;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
    width: 100%;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 1.1rem;
  }

  .form-select:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    outline: none;
  }

  .course-search {
    position: relative;
  }

  .course-search .form-control {
    padding-left: 2.5rem;
    border: 2px solid #e2e8f0;
    border-radius: 0.5rem;
    font-size: 1.1rem;
    width: 100%;
    transition: all 0.3s ease;
  }

  .course-search .form-control:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    outline: none;
  }

  .course-search .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #718096;
    pointer-events: none;
  }

  .feature-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    height: 100%;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .feature-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
  }
  .selected-types {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
    min-height: 2.5rem;
  }

  .selected-type-badge {
    background: #3498db;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    animation: fadeIn 0.3s ease;
  }

  .selected-type-badge button {
    background: none;
    border: none;
    color: white;
    padding: 0;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.3s ease;
    display: flex;
    align-items: center;
  }

  .selected-type-badge button:hover {
    opacity: 1;
  }

  .course-search-container {
    position: relative;
    margin-bottom: 1.5rem;
  }

  .course-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 2px solid #e2e8f0;
    border-top: none;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    display: none;
    scrollbar-width: thin;
    scrollbar-color: #3498db #f8fafc;
  }

  .course-suggestions::-webkit-scrollbar {
    width: 8px;
  }

  .course-suggestions::-webkit-scrollbar-track {
    background: #f8fafc;
    border-radius: 0 0 10px 0;
  }

  .course-suggestions::-webkit-scrollbar-thumb {
    background-color: #3498db;
    border-radius: 4px;
    border: 2px solid #f8fafc;
  }

  .course-suggestion-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid #f0f0f0;
  }

  .course-suggestion-item:last-child {
    border-bottom: none;
  }

  .course-suggestion-item:hover,
  .course-suggestion-item.active {
    background-color: rgba(52, 152, 219, 0.1);
  }

  .course-suggestion-item .course-name {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 0.25rem;
  }

  .course-suggestion-item .course-name strong {
    color: #3498db;
  }

  .course-suggestion-item .institution-count {
    font-size: 0.875rem;
    color: #6c757d;
  }

  .course-suggestions.show {
    display: block;
    animation: fadeInDown 0.3s ease;
  }

  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #loadingSpinner {
    display: none;
    justify-content: center;
    align-items: center;
    margin: 2rem 0;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  #loadingSpinner.show {
    opacity: 1;
  }

  /* Mobile Optimizations */
  @media (max-width: 768px) {
    .hero-section {
      background-attachment: scroll;
      padding: 2rem 0;
    }

    .institution-type-grid {
      grid-template-columns: 1fr;
    }

    .feature-card {
      margin-bottom: 1rem;
    }

    .course-suggestions {
      max-height: 250px;
    }

    .course-suggestion-item {
      padding: 0.5rem 1rem;
    }

    .selected-types {
      margin-top: 0.75rem;
    }

    .wizard-step {
      padding: 1.5rem;
    }

    .scroll-prompt {
      bottom: 1rem;
    }
  }

  /* Accessibility and Motion Preferences */
  @media (prefers-reduced-motion: reduce) {
    .hero-content,
    .feature-card,
    .institution-card,
    .selected-type-badge,
    .scroll-prompt {
      animation: none !important;
      transition: none !important;
    }

    .feature-card:hover,
    .institution-card:hover {
      transform: none !important;
    }
  }

  /* High Contrast Mode */
  @media (forced-colors: active) {
    .institution-card,
    .feature-card,
    .selected-type-badge {
      border: 2px solid currentColor;
    }

    .institution-card.selected {
      border: 2px solid currentColor;
      background: Canvas;
    }
  }

  html {
    scroll-behavior: smooth;
    height: 100%;
  }

  #wizard-container {
    scroll-margin-top: 2rem;
  }
</style>
{% endblock %} {% block content %}
<section class="hero-section" id="heroSection">
  <div class="container">
    <div class="hero-content text-center text-white mb-5">
      <h1 class="display-3 mb-4 fw-bold">Find Your Perfect Institution</h1>
      <p class="lead mb-5">
        Discover top Nigerian universities and courses tailored to your future.
      </p>
    </div>

    <div id="wizard-container" class="mx-auto" style="max-width: 800px">
      <!-- Step 1: Location and Institution Type Selection -->
      <div class="wizard-step active" id="step1">
        <h3 class="text-center mb-4">Choose Your Preferred Location</h3>
        <div class="form-group mb-4">
          <select
            id="location"
            class="form-select form-select-lg"
            aria-label="Select a State"
          >
            <option value="">Select a State</option>
          </select>
        </div>

        <h4 class="text-center mb-3">Select Institution Type</h4>
        <div class="selected-types" role="region" aria-live="polite"></div>
        <div
          class="institution-type-grid"
          id="institutionTypes"
          role="group"
          aria-label="Institution types"
        >
          <!-- Institution type cards will be inserted here via JavaScript -->
        </div>

        <button
          id="nextStep"
          class="btn btn-primary btn-lg w-100 mt-4"
          disabled
          aria-label="Continue to next step"
        >
          Continue <i class="fas fa-arrow-right ms-2" aria-hidden="true"></i>
        </button>
      </div>

      <!-- Step 2: Course Selection -->
      <div class="wizard-step" id="step2" aria-hidden="true">
        <h3 class="text-center mb-4">Choose Your Course</h3>

        <div
          id="loadingSpinner"
          class="text-center"
          role="status"
          aria-live="polite"
        >
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading courses...</span>
          </div>
          <p class="mt-2">Loading available courses...</p>
        </div>

        <div class="course-search-container">
          <div class="course-search">
            <i class="fas fa-search search-icon" aria-hidden="true"></i>
            <input
              type="text"
              id="courseSearch"
              class="form-control form-control-lg"
              placeholder="Search courses..."
              autocomplete="off"
              aria-label="Search courses"
              style="display: none"
            />
          </div>
          <div
            id="courseSuggestions"
            class="course-suggestions"
            role="listbox"
            aria-label="Course suggestions"
          ></div>
        </div>

        <div class="form-group mb-4">
          <select
            id="course"
            class="form-select form-select-lg"
            aria-label="Select a Course"
            style="display: none"
          >
            <option value="">Select a Course</option>
          </select>
        </div>

        <div class="d-grid gap-3">
          <button
            id="findInstitution"
            class="btn btn-primary btn-lg"
            style="display: none"
            aria-label="Find institutions offering this course"
          >
            Find Institution
            <i class="fas fa-search ms-2" aria-hidden="true"></i>
          </button>
          <button
            id="prevStep"
            class="btn btn-secondary btn-lg"
            aria-label="Go back to previous step"
          >
            <i class="fas fa-arrow-left me-2" aria-hidden="true"></i> Back
          </button>
        </div>
      </div>
    </div>

    <div class="scroll-prompt" aria-hidden="true" role="presentation">
      <i class="fas fa-chevron-down fa-2x"></i>
    </div>
  </div>
</section>
<section class="features-section py-5 bg-light">
  <div class="container">
    <h2 class="text-center mb-5">Why Choose Us?</h2>
    <div class="row g-4">
      <div class="col-md-4">
        <div class="feature-card text-center" role="article">
          <i
            class="fas fa-database fa-3x mb-4 text-primary"
            aria-hidden="true"
          ></i>
          <h3 class="h4 mb-3">Comprehensive Database</h3>
          <p class="text-muted mb-0">
            Access detailed information about all accredited Nigerian
            institutions and courses.
          </p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="feature-card text-center" role="article">
          <i
            class="fas fa-bullseye fa-3x mb-4 text-primary"
            aria-hidden="true"
          ></i>
          <h3 class="h4 mb-3">Smart Recommendations</h3>
          <p class="text-muted mb-0">
            Get personalized institution suggestions based on your preferences
            and requirements.
          </p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="feature-card text-center" role="article">
          <i
            class="fas fa-chart-line fa-3x mb-4 text-primary"
            aria-hidden="true"
          ></i>
          <h3 class="h4 mb-3">Detailed Analysis</h3>
          <p class="text-muted mb-0">
            Compare institutions and make informed decisions with our
            comprehensive insights.
          </p>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %} {% block extra_scripts %} {{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Constants and State Management
    const STATE = {
      selectedTypes: new Set(),
      currentCourses: [],
      isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
      prefersReducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches,
      isMobile: window.innerWidth <= 768
    };

    // DOM Elements
    const DOM = {
      heroSection: document.getElementById('heroSection'),
      locationSelect: document.getElementById("location"),
      institutionTypesGrid: document.getElementById("institutionTypes"),
      nextStepBtn: document.getElementById("nextStep"),
      prevStepBtn: document.getElementById("prevStep"),
      findInstitutionBtn: document.getElementById("findInstitution"),
      courseSelect: document.getElementById("course"),
      courseSearch: document.getElementById("courseSearch"),
      loadingSpinner: document.getElementById("loadingSpinner"),
      step1: document.getElementById("step1"),
      step2: document.getElementById("step2"),
      courseSuggestions: document.getElementById("courseSuggestions"),
      scrollPrompt: document.querySelector(".scroll-prompt")
    };

    // Program Groups Configuration
    const PROGRAMME_GROUPS = {
      "ALL DEGREE AWARDING INSTITUTIONS": [
        "E-LEARNING UNIVERSITIES OF NIGERIA",
        "FEDERAL UNIVERSITIES",
        "FEDERAL UNIVERSITIES OF AGRICULTURE",
        "FEDERAL UNIVERSITIES OF HEALTH SCIENCES",
        "FEDERAL UNIVERSITIES OF TECHNOLOGY",
        "OPEN AND DISTANCE LEARNING PROGRAMMES",
        "OTHER DEGREE AWARDING INSTITUTIONS",
        "PRIVATE UNIVERSITIES",
        "SANDWICH PROGRAMMES",
        "STATE UNIVERSITIES",
        "STATE UNIVERSITIES OF AGRICULTURE",
        "STATE UNIVERSITIES OF MEDICAL SCIENCES",
        "STATE UNIVERSITIES OF TECHNOLOGY",
      ],
      "ALL NCE": [
        "FEDERAL COLLEGES OF EDUCATION",
        "STATE COLLEGES OF EDUCATION",
        "PRIVATE COLLEGES OF EDUCATION",
      ]
    };

    // Optimized Parallax Implementation
    const PARALLAX = {
      init() {
        // Check if parallax should be disabled
        if (STATE.isIOS || STATE.prefersReducedMotion) {
          DOM.heroSection.style.backgroundAttachment = 'scroll';
          return;
        }

        // Add smooth scroll listener
        window.addEventListener('scroll', () => {
          // Only request animation frame if element is in viewport
          const rect = DOM.heroSection.getBoundingClientRect();
          if (rect.bottom > 0 && rect.top < window.innerHeight) {
            requestAnimationFrame(this.updatePosition);
          }
        }, { passive: true });

        // Handle reduced motion preference changes
        window.matchMedia('(prefers-reduced-motion: reduce)')
          .addEventListener('change', (e) => {
            STATE.prefersReducedMotion = e.matches;
            DOM.heroSection.style.backgroundAttachment = e.matches ? 'scroll' : 'fixed';
          });

        // Handle resize events
        window.addEventListener('resize', () => {
          STATE.isMobile = window.innerWidth <= 768;
          if (STATE.isMobile) {
            DOM.heroSection.style.backgroundAttachment = 'scroll';
          } else if (!STATE.isIOS && !STATE.prefersReducedMotion) {
            DOM.heroSection.style.backgroundAttachment = 'fixed';
          }
        }, { passive: true });
      },

      updatePosition() {
        if (STATE.isIOS || STATE.prefersReducedMotion) return;

        const scrolled = window.pageYOffset;
        const factor = STATE.isMobile ? 0.15 : 0.5;
        const yPos = -(scrolled * factor);

        DOM.heroSection.style.backgroundPositionY = `${yPos}px`;
      }
    };

    // Initialize background image loading
    const preloadHeroImage = () => {
      const img = new Image();
      img.src = "/static/images/hero.png";
      img.onload = () => {
        DOM.heroSection.style.backgroundImage =
          `linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('${img.src}')`;
        DOM.heroSection.classList.add("loaded");
      };
    };

    // Scroll prompt handler with throttling
    const handleScroll = () => {
      requestAnimationFrame(() => {
        DOM.scrollPrompt.style.opacity = window.pageYOffset > 100 ? "0" : "0.8";
      });
    };
    // Location Handler Implementation
  const LOCATION_HANDLER = {
    async loadLocations() {
      try {
        const response = await fetch("/api/locations");
        if (!response.ok) throw new Error('Failed to load locations');
        
        const locations = await response.json();
        this.populateLocations(locations);
      } catch (error) {
        console.error("Error loading locations:", error);
        this.showError("Failed to load locations. Please refresh the page.");
      }
    },

    populateLocations(locations) {
      // Sort locations alphabetically
      locations.sort().forEach(location => {
        const option = document.createElement("option");
        option.value = location;
        option.textContent = location;
        DOM.locationSelect.appendChild(option);
      });
    },

    async handleLocationChange(selectedState) {
      // Reset state
      STATE.selectedTypes.clear();
      STATE.currentCourses = [];
      DOM.nextStepBtn.disabled = true;
      DOM.institutionTypesGrid.innerHTML = '';
      
      if (!selectedState) return;

      try {
        const response = await fetch(
          `/api/programme_types?state=${encodeURIComponent(selectedState)}`
        );
        
        if (!response.ok) throw new Error('Failed to load programme types');
        
        const types = await response.json();
        INSTITUTION_HANDLER.createTypeCards(types);
        INSTITUTION_HANDLER.updateSelectedTypesDisplay();
      } catch (error) {
        console.error("Error loading programme types:", error);
        this.showError("Failed to load institution types. Please try again.");
      }
    },

    showError(message) {
      const errorDiv = document.createElement("div");
      errorDiv.className = "alert alert-danger mt-3";
      errorDiv.role = "alert";
      errorDiv.textContent = message;
      DOM.institutionTypesGrid.insertAdjacentElement('beforebegin', errorDiv);
      setTimeout(() => errorDiv.remove(), 5000);
    }
  };

  // Institution Handler Implementation
  const INSTITUTION_HANDLER = {
    createTypeCards(types) {
      const sortedTypes = types
        .filter(type => type !== "ALL_INSTITUTION_TYPES")
        .sort((a, b) => a.localeCompare(b));

      this.createSelectedTypesContainer();
      this.renderTypeCards(sortedTypes);
      this.addCardEventListeners();
    },

    createSelectedTypesContainer() {
      if (!document.querySelector(".selected-types")) {
        const selectedTypesContainer = document.createElement("div");
        selectedTypesContainer.className = "selected-types";
        selectedTypesContainer.setAttribute('aria-label', 'Selected institution types');
        selectedTypesContainer.setAttribute('role', 'region');
        selectedTypesContainer.setAttribute('aria-live', 'polite');
        DOM.institutionTypesGrid.insertAdjacentElement("beforebegin", selectedTypesContainer);
      }
    },

    renderTypeCards(types) {
      DOM.institutionTypesGrid.innerHTML = types
        .map(type => `
          <div 
            class="institution-card" 
            data-type="${type}"
            role="button"
            tabindex="0"
            aria-pressed="false"
            aria-label="${this.formatInstitutionType(type)}"
          >
            <i class="fas ${this.getInstitutionIcon(type)} mb-3 fa-2x" aria-hidden="true"></i>
            <h5 class="mb-2">${this.formatInstitutionType(type)}</h5>
            <p class="mb-0 small text-muted">Click to select</p>
          </div>
        `)
        .join("");
    },

    addCardEventListeners() {
      document.querySelectorAll(".institution-card").forEach(card => {
        const handleSelection = () => {
          const type = card.dataset.type;
          if (STATE.selectedTypes.has(type)) {
            this.removeInstitutionType(type);
          } else {
            this.addInstitutionType(type);
          }
          DOM.nextStepBtn.disabled = STATE.selectedTypes.size === 0;
        };

        // Click handler
        card.addEventListener("click", handleSelection);

        // Keyboard handler
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            handleSelection();
          }
        });
      });
    },

    addInstitutionType(type) {
      STATE.selectedTypes.add(type);
      const card = document.querySelector(`.institution-card[data-type="${type}"]`);
      if (card) {
        card.classList.add("selected");
        card.setAttribute('aria-pressed', 'true');
      }
      this.addSelectedTypeBadge(type);
    },

    removeInstitutionType(type) {
      STATE.selectedTypes.delete(type);
      const card = document.querySelector(`.institution-card[data-type="${type}"]`);
      if (card) {
        card.classList.remove("selected");
        card.setAttribute('aria-pressed', 'false');
      }
      this.removeSelectedTypeBadge(type);
    },

    updateSelectedTypesDisplay() {
      const container = document.querySelector(".selected-types");
      if (!container) return;

      container.innerHTML = "";
      Array.from(STATE.selectedTypes)
        .sort()
        .forEach(type => this.addSelectedTypeBadge(type));
    },

    addSelectedTypeBadge(type) {
      const container = document.querySelector(".selected-types");
      const badge = document.createElement("div");
      badge.className = "selected-type-badge";
      badge.dataset.type = type;
      badge.setAttribute('role', 'status');
      badge.innerHTML = `
        ${this.formatInstitutionType(type)}
        <button 
          onclick="removeInstitutionType('${type}')"
          aria-label="Remove ${this.formatInstitutionType(type)}"
        >
          <i class="fas fa-times" aria-hidden="true"></i>
        </button>
      `;
      container.appendChild(badge);
    },

    removeSelectedTypeBadge(type) {
      const badge = document.querySelector(`.selected-type-badge[data-type="${type}"]`);
      if (badge) {
        badge.style.animation = "fadeOut 0.3s ease";
        setTimeout(() => badge.remove(), 300);
      }
    },

    formatInstitutionType(type) {
      return type
        .split(/[ _]/g)
        .map(word => word.charAt(0) + word.slice(1).toLowerCase())
        .join(" ");
    },

    getInstitutionIcon(type) {
      const typeUpper = type.toUpperCase();
      
      if (typeUpper.includes("EDUCATION") && typeUpper.includes("TECHNICAL")) {
        return "fa-cog";
      }
      if (typeUpper.includes("POLYTECHNIC")) return "fa-industry";
      if (typeUpper.includes("UNIVERSITIES")) return "fa-university";
      if (typeUpper.includes("EDUCATION")) return "fa-chalkboard-teacher";
      if (typeUpper.includes("HEALTH") || typeUpper.includes("MEDICAL")) {
        return "fa-hospital";
      }
      if (typeUpper.includes("TECHNOLOGY") || typeUpper.includes("TECHNICAL")) {
        return "fa-microchip";
      }
      if (typeUpper.includes("AGRICULTURE")) return "fa-leaf";
      if (typeUpper.includes("DISTANCE") || typeUpper.includes("E-LEARNING")) {
        return "fa-laptop";
      }
      if (typeUpper.includes("COLLEGES")) return "fa-school";
      
      return "fa-graduation-cap";
    }
  };
  // Course Handler Implementation
  const COURSE_HANDLER = {
    async loadCourses(state, programTypes) {
      this.showLoading(true);

      try {
        const courses = await this.fetchCourses(state, programTypes);
        STATE.currentCourses = this.processCourses(courses);
        
        this.initializeSearchInterface();

        if (STATE.currentCourses.length === 0) {
          this.showInfo("No courses available for the selected location and institution types.");
        }
      } catch (error) {
        console.error("Error loading courses:", error);
        this.showError(`Failed to load courses: ${error.message}`);
      } finally {
        this.showLoading(false);
      }
    },

    async fetchCourses(state, programTypes) {
      const programTypesString = Array.from(programTypes).join(",");
      const response = await fetch(
        `/api/courses?state=${encodeURIComponent(state)}&programme_type=${encodeURIComponent(programTypesString)}`
      );

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
      }

      return response.json();
    },

    processCourses(courses) {
      if (!Array.isArray(courses)) throw new Error("Invalid response format from server");

      const coursesMap = new Map();

      courses.forEach(course => {
        const courseKey = course.course_name.toUpperCase();
        if (!coursesMap.has(courseKey)) {
          coursesMap.set(courseKey, {
            name: course.course_name,
            institutions: new Set([{
              name: course.university_name,
              state: course.state,
              type: course.program_type
            }]),
            details: {
              utme: course.utme_requirements,
              subjects: course.subjects,
              directEntry: course.direct_entry_requirements,
              abbreviation: course.abbrv
            }
          });
        } else {
          coursesMap.get(courseKey).institutions.add({
            name: course.university_name,
            state: course.state,
            type: course.program_type
          });
        }
      });

      return Array.from(coursesMap.values())
        .sort((a, b) => a.name.localeCompare(b.name));
    },

    initializeSearchInterface() {
      const searchInput = DOM.courseSearch;
      const suggestionsContainer = DOM.courseSuggestions;
      let selectedIndex = -1;

      this.showSearchInterface();
      this.attachSearchHandlers(searchInput, suggestionsContainer, selectedIndex);
      this.attachKeyboardNavigation(searchInput, suggestionsContainer);
      this.attachClickHandlers(suggestionsContainer);
      this.resetSearchState();
    },

    showSearchInterface() {
      DOM.courseSearch.style.display = "block";
      DOM.courseSelect.style.display = "block";
      this.populateCourseSelect(STATE.currentCourses);
    },

    attachSearchHandlers(searchInput, suggestionsContainer, selectedIndex) {
      const searchHandler = this.debounce((event) => {
        const query = event.target.value.toLowerCase().trim();

        if (!query) {
          suggestionsContainer.classList.remove("show");
          DOM.findInstitutionBtn.disabled = !DOM.courseSelect.value;
          this.populateCourseSelect(STATE.currentCourses);
          return;
        }

        const filteredCourses = STATE.currentCourses.filter(course =>
          course.name.toLowerCase().includes(query)
        );

        this.showSuggestions(filteredCourses, query);
        this.populateCourseSelect(filteredCourses);
        selectedIndex = -1;
      }, 300);

      searchInput.addEventListener("input", searchHandler);
    },

    attachKeyboardNavigation(searchInput, suggestionsContainer) {
      let selectedIndex = -1;

      searchInput.addEventListener("keydown", (e) => {
        const suggestions = document.querySelectorAll(".course-suggestion-item");

        switch (e.key) {
          case "ArrowDown":
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, suggestions.length - 1);
            this.updateSelection(suggestions, selectedIndex);
            break;

          case "ArrowUp":
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            this.updateSelection(suggestions, selectedIndex);
            break;

          case "Enter":
            e.preventDefault();
            if (selectedIndex >= 0 && suggestions[selectedIndex]) {
              this.selectSuggestion(suggestions[selectedIndex]);
            }
            break;

          case "Escape":
            suggestionsContainer.classList.remove("show");
            selectedIndex = -1;
            break;
        }
      });
    },

    attachClickHandlers(suggestionsContainer) {
      suggestionsContainer.addEventListener("click", (e) => {
        const suggestion = e.target.closest(".course-suggestion-item");
        if (suggestion) {
          this.selectSuggestion(suggestion);
        }
      });

      // Close suggestions on outside click
      document.addEventListener("click", (e) => {
        if (!DOM.courseSearch.contains(e.target) && !suggestionsContainer.contains(e.target)) {
          suggestionsContainer.classList.remove("show");
        }
      });
    },

    showSuggestions(suggestions, query) {
      const suggestionsContainer = DOM.courseSuggestions;
      
      if (suggestions.length === 0) {
        suggestionsContainer.classList.remove("show");
        return;
      }

      const html = suggestions.map((course, index) => `
        <div 
          class="course-suggestion-item" 
          data-index="${index}" 
          data-value="${course.name}"
          data-institutions='${JSON.stringify(Array.from(course.institutions))}'
          role="option"
          aria-selected="false"
        >
          <div class="course-name">
            ${this.highlightMatch(course.name, query)}
          </div>
          <div class="institution-count">
            ${course.institutions.size} ${course.institutions.size === 1 ? "institution" : "institutions"} available
          </div>
        </div>
      `).join("");

      suggestionsContainer.innerHTML = html;
      suggestionsContainer.classList.add("show");
    },

    updateSelection(suggestions, selectedIndex) {
      suggestions.forEach((suggestion, index) => {
        suggestion.classList.toggle("active", index === selectedIndex);
        suggestion.setAttribute("aria-selected", index === selectedIndex);
        if (index === selectedIndex) {
          suggestion.scrollIntoView({ block: "nearest" });
        }
      });
    },

    selectSuggestion(suggestionElement) {
      const courseName = suggestionElement.dataset.value;
      const institutions = JSON.parse(suggestionElement.dataset.institutions);

      DOM.courseSearch.value = courseName;
      DOM.courseSuggestions.classList.remove("show");

      DOM.courseSelect.value = courseName;
      DOM.findInstitutionBtn.disabled = false;
    },

    populateCourseSelect(courses) {
      DOM.courseSelect.innerHTML = '<option value="">Select a Course</option>';
      
      courses.forEach((course) => {
        const option = document.createElement("option");
        option.value = course.name;
        option.dataset.institutions = JSON.stringify(Array.from(course.institutions));
        option.textContent = `${course.name} (${course.institutions.size} ${
          course.institutions.size === 1 ? "institution" : "institutions"
        })`;
        DOM.courseSelect.appendChild(option);
      });
    },

    // Utility functions
    showLoading(show) {
      DOM.loadingSpinner.style.display = show ? "flex" : "none";
      DOM.courseSelect.style.display = show ? "none" : "block";
      DOM.courseSearch.style.display = show ? "none" : "block";
      DOM.findInstitutionBtn.style.display = show ? "none" : "block";
      if (!show) DOM.findInstitutionBtn.disabled = true;
    },

    debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func.apply(this, args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    },

    highlightMatch(text, query) {
      if (!query) return text;
      const cleanQuery = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const regex = new RegExp(`(${cleanQuery})`, "gi");
      return text.replace(regex, "<strong>$1</strong>");
    },

    resetSearchState() {
      DOM.courseSearch.value = "";
      DOM.findInstitutionBtn.disabled = true;
    },

    showInfo(message) {
      this.showMessage(message, 'info');
    },

    showError(message) {
      this.showMessage(message, 'danger');
    },

    showMessage(message, type) {
      const div = document.createElement("div");
      div.className = `alert alert-${type} mt-3`;
      div.role = "alert";
      div.textContent = message;
      DOM.step2.appendChild(div);
      setTimeout(() => div.remove(), 5000);
    }
  };
  // Navigation Handler Implementation
  const NAVIGATION_HANDLER = {
    initialize() {
      this.initializeStepNavigation();
      this.initializeButtonHandlers();
      this.initializeKeyboardNavigation();
    },

    initializeStepNavigation() {
      DOM.nextStepBtn.addEventListener("click", () => {
        if (DOM.locationSelect.value && STATE.selectedTypes.size > 0) {
          this.moveToStep2();
        }
      });

      DOM.prevStepBtn.addEventListener("click", () => {
        this.moveToStep1();
      });
    },

    initializeButtonHandlers() {
      // Find institution button handler
      DOM.findInstitutionBtn.addEventListener("click", () => {
        this.handleFindInstitution();
      });

      // Course select change handler
      DOM.courseSelect.addEventListener("change", (e) => {
        const selectedOption = e.target.options[e.target.selectedIndex];
        if (selectedOption.value) {
          DOM.courseSearch.value = selectedOption.value;
          DOM.findInstitutionBtn.disabled = false;
        } else {
          DOM.courseSearch.value = "";
          DOM.findInstitutionBtn.disabled = true;
        }
        DOM.courseSuggestions.classList.remove("show");
      });
    },

    initializeKeyboardNavigation() {
      document.addEventListener("keydown", (e) => {
        if (DOM.step2.classList.contains("active")) {
          if (e.key === "Escape") {
            this.moveToStep1();
          } else if (e.key === "Enter" && !DOM.findInstitutionBtn.disabled) {
            this.handleFindInstitution();
          }
        }
      });
    },

    moveToStep2() {
      const wizardContainer = document.getElementById("wizard-container");
      
      // Smooth scroll to wizard container
      wizardContainer.scrollIntoView({
        behavior: STATE.prefersReducedMotion ? "auto" : "smooth",
        block: "start"
      });

      // Switch steps with animation
      setTimeout(() => {
        DOM.step1.classList.remove("active");
        DOM.step1.setAttribute("aria-hidden", "true");
        DOM.step2.classList.add("active");
        DOM.step2.setAttribute("aria-hidden", "false");
        
        // Load courses for selected location and types
        COURSE_HANDLER.loadCourses(
          DOM.locationSelect.value, 
          STATE.selectedTypes
        );
      }, STATE.prefersReducedMotion ? 0 : 500);
    },

    moveToStep1() {
      DOM.step2.classList.remove("active");
      DOM.step2.setAttribute("aria-hidden", "true");
      DOM.step1.classList.add("active");
      DOM.step1.setAttribute("aria-hidden", "false");
    },

    handleFindInstitution() {
      const selectedOption = DOM.courseSelect.options[DOM.courseSelect.selectedIndex];
      
      const params = new URLSearchParams({
        location: DOM.locationSelect.value,
        programme_type: Array.from(STATE.selectedTypes).join(","),
        course: selectedOption.value,
        institutions: selectedOption.dataset.institutions
      });

      window.location.href = `/recommend?${params}`;
    }
  };

  // Accessibility Handler Implementation
  const ACCESSIBILITY_HANDLER = {
    initialize() {
      this.setupLiveRegion();
      this.setupKeyboardNavigation();
      this.setupFocusManagement();
    },

    setupLiveRegion() {
      const liveRegion = document.createElement('div');
      liveRegion.setAttribute('aria-live', 'polite');
      liveRegion.setAttribute('aria-atomic', 'true');
      liveRegion.className = 'visually-hidden';
      document.body.appendChild(liveRegion);
    },

    setupKeyboardNavigation() {
      DOM.institutionTypesGrid.addEventListener('keydown', (e) => {
        if (e.target.classList.contains('institution-card')) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            e.target.click();
          }
        }
      });
    },

    setupFocusManagement() {
      [DOM.step1, DOM.step2].forEach(step => {
        this.trapFocus(step);
      });
    },

    trapFocus(element) {
      const focusableElements = element.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstFocusable = focusableElements[0];
      const lastFocusable = focusableElements[focusableElements.length - 1];

      element.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === firstFocusable) {
            e.preventDefault();
            lastFocusable.focus();
          } else if (!e.shiftKey && document.activeElement === lastFocusable) {
            e.preventDefault();
            firstFocusable.focus();
          }
        }
      });
    }
  };

  // Global remove institution type function
  window.removeInstitutionType = function(type) {
    INSTITUTION_HANDLER.removeInstitutionType(type);
    DOM.nextStepBtn.disabled = STATE.selectedTypes.size === 0;
  };

  // Initialize Application
  const initializeApp = () => {
    // Initialize core features
    PARALLAX.init();
    preloadHeroImage();

    // Add scroll event listener
    window.addEventListener("scroll", handleScroll, { passive: true });

    // Load initial data
    LOCATION_HANDLER.loadLocations();

    // Set up location change handler
    DOM.locationSelect.addEventListener("change", (e) => 
      LOCATION_HANDLER.handleLocationChange(e.target.value)
    );

    // Initialize navigation
    NAVIGATION_HANDLER.initialize();

    // Initialize accessibility features
    ACCESSIBILITY_HANDLER.initialize();
  };

  // Start the application
  initializeApp();
});
</script>
{% endblock %}