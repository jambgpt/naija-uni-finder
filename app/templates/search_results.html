<!-- app/templates/search_results.html -->
{% extends "base.html" %}
{% block title %}Search Results - Naija! Find Uni{% endblock %}

{% block extra_head %}
<style>
  .hero-section {
    background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('/static/images/hero.png');
    background-size: cover;
    background-position: center;
    padding: 4rem 0;
    color: white;
    margin-bottom: 3rem;
  }

  .result-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    height: 100%;
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .result-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
  }

  .filter-section {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 2rem;
  }

  .filter-group {
    margin-bottom: 1.5rem;
  }

  .filter-group:last-child {
    margin-bottom: 0;
  }

  .custom-checkbox {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    cursor: pointer;
  }

  .custom-checkbox input {
    margin-right: 0.5rem;
  }

  .nav-tabs {
    border-bottom: 2px solid #e2e8f0;
    margin-bottom: 2rem;
  }

  .nav-tabs .nav-link {
    border: none;
    color: #64748b;
    padding: 0.75rem 1rem;
    margin-right: 1rem;
    font-weight: 500;
    position: relative;
    background: transparent;
  }

  .nav-tabs .nav-link:hover {
    color: #3498db;
  }

  .nav-tabs .nav-link.active {
    color: #3498db;
    background: transparent;
  }

  .nav-tabs .nav-link.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: #3498db;
  }

  .results-count {
    color: #64748b;
    margin-bottom: 1.5rem;
  }

  .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .institution-type {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  .type-federal { background: #e3f2fd; color: #1976d2; }
  .type-state { background: #e8f5e9; color: #388e3c; }
  .type-private { background: #fff3e0; color: #f57c00; }

  .modal-content {
    border-radius: 15px;
    border: none;
  }

  .modal-header {
    background: linear-gradient(to right, #3498db, #2980b9);
    color: white;
    border-radius: 15px 15px 0 0;
  }

  .course-requirements {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
  }

  @media (max-width: 991.98px) {
    .filter-section {
      position: static;
      margin-bottom: 1.5rem;
    }
  }

  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .no-results {
    text-align: center;
    padding: 3rem;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .no-results i {
    font-size: 3rem;
    color: #3498db;
    margin-bottom: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 text-center">
        <h1 class="mb-4">Search Results</h1>
        <form class="d-flex justify-content-center" action="{{ url_for('main.search_results') }}" method="GET">
          <div class="input-group input-group-lg" style="max-width: 600px;">
            <input type="text" class="form-control" name="q" value="{{ query }}" placeholder="Search institutions or courses...">
            <button class="btn btn-primary" type="submit">
              <i class="fas fa-search me-2"></i>Search
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<div class="container">
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mb-0">Loading results...</p>
    </div>
  </div>

  <div class="row">
    <!-- Filters Sidebar -->
    <div class="col-lg-3 mb-4">
      <div class="filter-section">
        <h4 class="mb-4">Filters</h4>
        <form id="filterForm">
          <!-- State Filter -->
          <div class="filter-group">
            <label class="fw-bold mb-2">State</label>
            <select class="form-select" id="stateFilter" name="state">
              <option value="">All States</option>
              {% for state in states %}
              <option value="{{ state }}" {% if selected_state == state %}selected{% endif %}>
                {{ state }}
              </option>
              {% endfor %}
            </select>
          </div>

          <!-- Institution Type Filter -->
          <div class="filter-group">
            <label class="fw-bold mb-2">Institution Type</label>
            <div class="custom-checkboxes">
              {% for type in institution_types %}
              <label class="custom-checkbox">
                <input type="checkbox" name="type" value="{{ type }}" 
                       {% if type in selected_types %}checked{% endif %}>
                {{ type|title }}
              </label>
              {% endfor %}
            </div>
          </div>

          <!-- Program Level Filter -->
          <div class="filter-group">
            <label class="fw-bold mb-2">Program Level</label>
            <div class="custom-checkboxes">
              {% for level in program_levels %}
              <label class="custom-checkbox">
                <input type="checkbox" name="level" value="{{ level }}"
                       {% if level in selected_levels %}checked{% endif %}>
                {{ level|title }}
              </label>
              {% endfor %}
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-filter me-2"></i>Apply Filters
          </button>
        </form>
      </div>
    </div>

    <!-- Results Section -->
    <div class="col-lg-9">
      <!-- Results Count -->
      <div class="results-count">
        Found {{ total_results }} results for "{{ query }}"
      </div>

      <!-- Results Tabs -->
      <ul class="nav nav-tabs" id="resultTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="institutions-tab" data-bs-toggle="tab" 
                  data-bs-target="#institutions" type="button" role="tab">
              <i class="fas fa-university me-2"></i>Institutions ({{ universities_count }})
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="courses-tab" data-bs-toggle="tab" 
                  data-bs-target="#courses" type="button" role="tab">
              <i class="fas fa-book me-2"></i>Courses ({{ courses_count }})
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="resultTabsContent">
      <!-- Institutions Tab -->
      <div class="tab-pane fade show active" id="institutions" role="tabpanel">
        {% if universities %}
        <div class="row g-4">
          {% for university in universities %}
          <div class="col-md-6">
            <div class="result-card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h5 class="card-title mb-0">{{ university.university_name }}</h5>
                  <span class="institution-type type-{{ university.program_type|lower }}">
                    {{ university.program_type }}
                  </span>
                </div>
                <p class="card-text">
                  <i class="fas fa-map-marker-alt me-2 text-primary"></i>{{ university.state }}
                </p>
                <div class="mt-3">
                  <a href="{{ url_for('university.institution_details', id=university.id) }}" 
                    class="btn btn-primary w-100">
                    <i class="fas fa-info-circle me-2"></i>View Details
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="no-results">
          <i class="fas fa-university mb-3"></i>
          <h3>No Institutions Found</h3>
          <p class="text-muted">Try adjusting your search criteria or filters</p>
        </div>
        {% endif %}
      </div>


        <!-- Courses Tab -->
        <div class="tab-pane fade" id="courses" role="tabpanel">
          {% if courses %}
          <div class="row g-4">
            {% for course in courses %}
            <div class="col-md-6">
              <div class="result-card">
                <div class="card-body">
                  <h5 class="card-title mb-3">{{ course.course_name }}</h5>
                  <p class="card-text mb-2">
                    <i class="fas fa-university me-2 text-primary"></i>{{ course.university_name }}
                  </p>
                  <p class="card-text mb-3">
                    <i class="fas fa-graduation-cap me-2 text-success"></i>{{ course.abbrv }}
                  </p>
                  <button class="btn btn-primary w-100" data-bs-toggle="modal" 
                          data-bs-target="#courseModal{{ course.id }}">
                    <i class="fas fa-info-circle me-2"></i>View Requirements
                  </button>
                </div>
              </div>
            </div>

            <!-- Course Modal -->
            <div class="modal fade" id="courseModal{{ course.id }}" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">{{ course.course_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <h6 class="mb-3">
                      <i class="fas fa-university me-2 text-primary"></i>{{ course.university_name }}
                    </h6>
                    <div class="course-requirements">
                      <h6 class="mb-3">Entry Requirements</h6>
                      <div class="mb-3">
                        <strong>UTME Requirements:</strong>
                        <p class="mb-2">{{ course.utme_requirements }}</p>
                      </div>
                      <div class="mb-3">
                        <strong>Required Subjects:</strong>
                        <p class="mb-2">{{ course.subjects }}</p>
                      </div>
                      <div>
                        <strong>Direct Entry Requirements:</strong>
                        <p class="mb-0">{{ course.direct_entry_requirements }}</p>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <a href="{{ url_for('university.institution_details', id=course.university.id) }}" 
                       class="btn btn-primary">
                      <i class="fas fa-university me-2"></i>View Institution
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="no-results">
            <i class="fas fa-book mb-3"></i>
            <h3>No Courses Found</h3>
            <p class="text-muted">Try adjusting your search criteria or filters</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const filterForm = document.getElementById('filterForm');
    
    // Handle new search - clear filters
    const searchForm = document.querySelector('form[action*="search_results"]');
    if (searchForm) {
        searchForm.addEventListener('submit', function() {
            // Clear all saved filters when starting a new search
            localStorage.removeItem('filter_state');
            localStorage.removeItem('filter_type');
            localStorage.removeItem('filter_level');
        });
    }
    
    // Handle filter form submission
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            loadingOverlay.style.display = 'flex';
            
            const formData = new FormData(this);
            const searchParams = new URLSearchParams();
            
            // Handle multiple checkbox selections for type
            const selectedTypes = formData.getAll('type');
            selectedTypes.forEach(type => {
                searchParams.append('type', type);
            });
            
            // Add other form data
            const state = formData.get('state');
            if (state) {
                searchParams.append('state', state);
            }
            
            // Preserve search query
            const currentQuery = new URLSearchParams(window.location.search).get('q');
            if (currentQuery) {
                searchParams.append('q', currentQuery);
            }
            
            // Navigate to filtered results
            window.location.href = `${window.location.pathname}?${searchParams.toString()}`;
        });
    }

    // Handle tab transitions
    const tabLinks = document.querySelectorAll('.nav-link');
    tabLinks.forEach(link => {
        link.addEventListener('click', function() {
            tabLinks.forEach(tab => tab.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Initialize tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(tooltipTriggerEl => {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Save filter state
    const filterInputs = document.querySelectorAll('#filterForm input, #filterForm select');
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (input.type === 'checkbox') {
                localStorage.setItem(`filter_${input.name}_${input.value}`, input.checked);
            } else {
                localStorage.setItem(`filter_${input.name}`, input.value);
            }
        });
    });

    // Restore filter state only if there's no active search
    if (!new URLSearchParams(window.location.search).has('q')) {
        filterInputs.forEach(input => {
            if (input.type === 'checkbox') {
                const savedValue = localStorage.getItem(`filter_${input.name}_${input.value}`);
                if (savedValue !== null) {
                    input.checked = savedValue === 'true';
                }
            } else {
                const savedValue = localStorage.getItem(`filter_${input.name}`);
                if (savedValue) {
                    input.value = savedValue;
                }
            }
        });
    }

    // Handle course modals
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('show.bs.modal', function() {
            const modalBody = this.querySelector('.modal-body');
            if (modalBody.querySelector('.course-requirements')) {
                // Content is already loaded
                return;
            }
            // Add loading spinner if needed for dynamic content
            modalBody.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>`;
        });
    });
});
</script>
{% endblock %}