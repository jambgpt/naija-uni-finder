<!-- app/templates/contact.html -->
{% extends "base.html" %} {% block title %}Contact Us - Nigerian Institutions
Finder{% endblock %} {% block content %}
<div class="container my-5">
  <h1 class="mb-4 text-center">Get in Touch & Join the Conversation</h1>
  <p class="text-center">
    We appreciate your feedback. Contact us using the form below or other
    channels. Sign in to join our comment section - share thoughts, discuss
    Nigerian institutions, or register complaints. Your insights are valuable to
    our community!
  </p>

  <div class="row mt-5">
    <!-- Comments Section -->
    <div class="col-12 col-md-6 mb-4 order-1">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0"><i class="fas fa-comments me-2"></i>Comments</h2>
        {% if current_user.is_authenticated %}
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#addCommentModal"
        >
          <i class="fas fa-plus-circle me-1"></i> Add Comment
        </button>
        {% else %}
        <button
          class="btn btn-primary"
          data-bs-toggle="tooltip"
          data-bs-placement="top"
          title="Sign in to add a comment"
          onclick="window.location.href='{{ url_for('auth.login') }}'"
        >
          <i class="fas fa-plus-circle me-1"></i> Add Comment
        </button>
        {% endif %}
      </div>
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="comments-section">
            {% if not current_user.is_authenticated %}
            <div class="alert alert-info mb-3" role="alert">
              <i class="fas fa-info-circle me-2"></i>
              Sign in to comment, like, and interact with others.
            </div>
            {% endif %}
            <h3 class="h6 mb-3">Recent Comments</h3>
            {% if comments %}
            <div class="comment-container">
              {% for comment in comments %}
              <div class="list-group mb-3">
                <div class="list-group-item">
                  <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">
                      <span
                        class="{% if comment.author.is_admin %}admin-username{% endif %}"
                      >
                        {{ comment.author.username }}
                      </span>
                      <span class="badge user-score bg-secondary">
                        {{ comment.author.score }}
                      </span>
                    </h5>
                    <small class="text-muted">
                      {{ comment.date_posted.strftime('%Y-%m-%d %H:%M') }}
                    </small>
                  </div>
                  <p class="mb-1">{{ comment.content }}</p>
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <button
                        class="btn btn-sm btn-outline-primary me-2 vote-btn"
                        data-comment-id="{{ comment.id }}"
                        data-vote-type="like"
                      >
                        <i class="fas fa-thumbs-up"></i>
                        Like
                        <span class="like-count">({{ comment.likes }})</span>
                      </button>
                      <button
                        class="btn btn-sm btn-outline-danger me-2 vote-btn"
                        data-comment-id="{{ comment.id }}"
                        data-vote-type="dislike"
                      >
                        <i class="fas fa-thumbs-down"></i>
                        Dislike
                        <span class="dislike-count"
                          >({{ comment.dislikes }})</span
                        >
                      </button>
                    </div>
                    {% if current_user.is_authenticated and (current_user.id ==
                    comment.user_id or current_user.is_admin) %}
                    <form
                      action="{{ url_for('main.delete_comment', comment_id=comment.id) }}"
                      method="POST"
                      class="d-inline"
                    >
                      {{ form.hidden_tag() }}
                      <button type="submit" class="btn btn-sm btn-danger">
                        <i class="fas fa-trash-alt"></i> Delete
                      </button>
                    </form>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">No comments yet. Be the first to comment!</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <!-- Contact Form Section -->
    <div class="col-12 col-md-6 mb-4 order-2">
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">
          <h2 class="h5 mb-0">
            <i class="fas fa-envelope me-2"></i>Contact Form
          </h2>
        </div>
        <div class="card-body">
          <form action="{{ url_for('main.contact') }}" method="POST" novalidate>
            {{ form.hidden_tag() }}
            <div class="mb-3">
              {{ form.name.label(class="form-label") }} {{
              form.name(class="form-control", placeholder="Enter your full
              name", required=true) }}
              <div class="invalid-feedback">Please enter your name.</div>
            </div>
            <div class="mb-3">
              {{ form.email.label(class="form-label") }} {{
              form.email(class="form-control", placeholder="Enter your email",
              required=true) }}
              <div class="invalid-feedback">
                Please enter a valid email address.
              </div>
            </div>
            <div class="mb-3">
              {{ form.subject.label(class="form-label") }} {{
              form.subject(class="form-control", placeholder="Subject of your
              message", required=true) }}
              <div class="invalid-feedback">Please enter a subject.</div>
            </div>
            <div class="mb-3">
              {{ form.message.label(class="form-label") }} {{
              form.message(class="form-control", rows="5", placeholder="Write
              your message here...", required=true) }}
              <div class="invalid-feedback">Please enter your message.</div>
            </div>
            {{ form.submit(class="btn btn-primary w-100") }}
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Comment Modal -->
{% if current_user.is_authenticated %}
<div
  class="modal fade"
  id="addCommentModal"
  tabindex="-1"
  aria-labelledby="addCommentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('main.add_comment') }}" method="POST" novalidate>
        {{ form.hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title" id="addCommentModalLabel">
            <i class="fas fa-comment-dots me-2"></i>Add a Comment
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="comment" class="form-label">Your Comment</label>
            <textarea
              class="form-control"
              id="comment"
              name="comment"
              rows="4"
              maxlength="200"
              placeholder="Write your comment here..."
              required
            ></textarea>
            <div class="form-text text-end" id="charCount">
              200 characters remaining
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            <i class="fas fa-times me-1"></i> Close
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane me-1"></i> Post Comment
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- Toast Container -->
<div
  class="toast-container position-fixed bottom-0 end-0 p-3"
  id="toastContainer"
></div>

{% endblock %} {% block extra_scripts %} {{ super() }}
<script>
  window.isAuthenticated =
    "{{ 'true' if current_user.is_authenticated else 'false' }}";
  const csrfToken = "{{ csrf_token() }}";
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Character count for comment textarea
    const commentTextarea = document.getElementById("comment");
    const charCount = document.getElementById("charCount");
    if (commentTextarea && charCount) {
      commentTextarea.addEventListener("input", function () {
        const remaining = 200 - this.value.length;
        charCount.textContent = `${remaining} characters remaining`;
        charCount.classList.toggle("text-danger", remaining < 20);
      });
    }

    // Vote button handlers
    document.querySelectorAll(".vote-btn").forEach((button) => {
      button.addEventListener("click", function (event) {
        event.preventDefault();

        if (window.isAuthenticated !== "true") {
          window.location.href = "/auth/login";
          return;
        }

        const commentId = this.getAttribute("data-comment-id");
        const voteType = this.getAttribute("data-vote-type");
        const loadingSpinner =
          '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>';
        const originalContent = this.innerHTML;

        // Show loading state
        this.innerHTML =
          loadingSpinner + (voteType === "like" ? "Liking..." : "Disliking...");
        this.disabled = true;

        // Fetch URL
        const fetchUrl = `/api/vote/${commentId}/${voteType}`;
        console.log(`Fetching URL: ${fetchUrl}`);

        fetch(fetchUrl, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          credentials: "same-origin",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not OK");
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              const comment = this.closest(".list-group-item");
              const likeButton = comment.querySelector(
                '[data-vote-type="like"]'
              );
              const dislikeButton = comment.querySelector(
                '[data-vote-type="dislike"]'
              );

              // Update vote counts
              likeButton.querySelector(
                ".like-count"
              ).textContent = `(${data.likes})`;
              dislikeButton.querySelector(
                ".dislike-count"
              ).textContent = `(${data.dislikes})`;

              // Update button states
              if (data.user_vote === "like") {
                likeButton.classList.add("active");
                dislikeButton.classList.remove("active");
              } else if (data.user_vote === "dislike") {
                dislikeButton.classList.add("active");
                likeButton.classList.remove("active");
              } else {
                likeButton.classList.remove("active");
                dislikeButton.classList.remove("active");
              }

              showToast("Vote recorded successfully", "success");
            } else {
              showToast(data.message || "Failed to process vote", "danger");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            showToast("An error occurred while processing your vote", "danger");
          })
          .finally(() => {
            // Restore button state
            this.innerHTML = originalContent;
            this.disabled = false;
          });
      });
    });

    // Function to update vote button states
    function updateVoteButtonStates() {
      if (window.isAuthenticated !== "true") return;

      fetch("/api/user_votes")
        .then((response) => {
          if (!response.ok) throw new Error("Failed to fetch vote states");
          return response.json();
        })
        .then((votes) => {
          document.querySelectorAll(".vote-btn").forEach((button) => {
            const commentId = button.getAttribute("data-comment-id");
            const voteType = button.getAttribute("data-vote-type");

            if (
              votes[voteType === "like" ? "liked" : "disliked"].includes(
                parseInt(commentId)
              )
            ) {
              button.classList.add("active");
            } else {
              button.classList.remove("active");
            }
          });
        })
        .catch((error) => {
          console.error("Error fetching vote states:", error);
        });
    }

    // Function to show toast notifications
    function showToast(message, type = "info") {
      const toastContainer = document.getElementById("toastContainer");
      const toastHTML = `
      <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
              <div class="toast-body">
                  ${message}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
      </div>
    `;

      const toastElement = document.createElement("div");
      toastElement.innerHTML = toastHTML;
      toastContainer.appendChild(toastElement.firstChild);

      const toast = new bootstrap.Toast(toastContainer.lastChild, {
        autohide: true,
        delay: 3000,
      });
      toast.show();

      // Remove toast from DOM after it's hidden
      toastContainer.lastChild.addEventListener("hidden.bs.toast", function () {
        this.remove();
      });
    }

    // Bootstrap form validation
    const forms = document.querySelectorAll("form[novalidate]");
    Array.from(forms).forEach((form) => {
      form.addEventListener(
        "submit",
        function (event) {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add("was-validated");
        },
        false
      );
    });

    // Initialize vote states on page load
    updateVoteButtonStates();
  });
</script>
{% endblock %}
