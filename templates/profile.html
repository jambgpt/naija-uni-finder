<!-- templates/profile.html -->
{% extends "base.html" %} {% block title %}{{ user.username }}'s Profile -
Nigerian Institutions Finder{% endblock %} {% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-body">
          <h2 class="card-title">{{ user.username }}</h2>
          <p class="card-text"><strong>Email:</strong> {{ user.email }}</p>
          <p class="card-text"><strong>User Score:</strong> {{ user.score }}</p>
          {% if current_user.id == user.id %}
          <a href="{{ url_for('change_password') }}" class="btn btn-primary"
            >Change Password</a
          >
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <ul class="nav nav-tabs" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="bookmarks-tab"
            data-bs-toggle="tab"
            data-bs-target="#bookmarks"
            type="button"
            role="tab"
            aria-controls="bookmarks"
            aria-selected="true"
          >
            Bookmarks
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="comments-tab"
            data-bs-toggle="tab"
            data-bs-target="#comments"
            type="button"
            role="tab"
            aria-controls="comments"
            aria-selected="false"
          >
            Comments
          </button>
        </li>
      </ul>
      <div class="tab-content mt-3" id="profileTabsContent">
        <div
          class="tab-pane fade show active"
          id="bookmarks"
          role="tabpanel"
          aria-labelledby="bookmarks-tab"
        >
          <h3 class="mb-3">Bookmarked Institutions</h3>
          {% if user.bookmarks %}
          <div class="list-group">
            {% for bookmark in user.bookmarks %}
            <div
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            >
              <a
                href="#"
                class="institution-details-link"
                data-bs-toggle="modal"
                data-bs-target="#institutionModal"
                data-uni-id="{{ bookmark.university_id }}"
              >
                {{ bookmark.university.university_name }}
              </a>
              {% if current_user.id == user.id %}
              <button
                class="btn btn-sm btn-outline-danger remove-bookmark"
                data-bookmark-id="{{ bookmark.id }}"
              >
                <i class="fas fa-times"></i> Remove
              </button>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted">No bookmarked institutions.</p>
          {% endif %}
        </div>
        <div
          class="tab-pane fade"
          id="comments"
          role="tabpanel"
          aria-labelledby="comments-tab"
        >
          <h3 class="mb-3">Comments</h3>
          {% if user.comments %} {% for comment in user.comments %}
          <div class="card mb-3">
            <div class="card-body">
              <p class="card-text">{{ comment.content }}</p>
              <p class="card-text">
                <small class="text-muted"
                  >Posted on: {{ comment.date_posted.strftime('%Y-%m-%d
                  %H:%M:%S') }}</small
                >
              </p>
              <p class="card-text">Comment Score: {{ comment.score }}</p>
            </div>
          </div>
          {% endfor %} {% else %}
          <p class="text-muted">No comments yet.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Institution Modal -->
<div
  class="modal fade"
  id="institutionModal"
  tabindex="-1"
  aria-labelledby="institutionModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="institutionModalLabel">
          <i class="fas fa-university me-2"></i> Institution Details
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div
          id="loadingIndicator"
          class="text-center mb-3"
          style="display: none"
        >
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div id="institutionDetails" style="display: none">
          <h2 id="institutionName"></h2>
          <p><strong>State:</strong> <span id="institutionState"></span></p>
          <p>
            <strong>Program Type:</strong>
            <span id="institutionProgramType"></span>
          </p>
          <p>
            <strong>Search Criteria:</strong> <span id="searchCriteria"></span>
          </p>

          <div id="selectedCourseDetails" style="display: none">
            <h4>Selected Course</h4>
            <div id="selectedCourseContent"></div>
          </div>

          <h3>Courses</h3>
          <div id="institutionCoursesList"></div>
        </div>
        <div
          id="modalErrorMessage"
          class="alert alert-danger"
          role="alert"
          style="display: none"
        ></div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %} {{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const institutionModal = document.getElementById("institutionModal");
    const removeButtons = document.querySelectorAll(".remove-bookmark");

    institutionModal.addEventListener("show.bs.modal", function (event) {
      const button = event.relatedTarget;
      const uniId = button.getAttribute("data-uni-id");
      fetchInstitutionDetails(uniId);
    });

    removeButtons.forEach((button) => {
      button.addEventListener("click", function (event) {
        event.preventDefault();
        const bookmarkId = this.getAttribute("data-bookmark-id");
        removeBookmark(bookmarkId, this);
      });
    });

    function fetchInstitutionDetails(uniId) {
      const loadingIndicator = document.getElementById("loadingIndicator");
      const institutionDetails = document.getElementById("institutionDetails");
      const modalErrorMessage = document.getElementById("modalErrorMessage");

      loadingIndicator.style.display = "block";
      institutionDetails.style.display = "none";
      modalErrorMessage.style.display = "none";

      fetch(`/api/institution/${uniId}`, {
        headers: {
          "X-CSRFToken": "{{ csrf_token() }}",
          Accept: "application/json",
        },
        credentials: "same-origin",
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          loadingIndicator.style.display = "none";
          institutionDetails.style.display = "block";
          populateInstitutionDetails(data);
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          modalErrorMessage.style.display = "block";
          modalErrorMessage.textContent =
            "Error loading institution details. Please try again.";
          console.error("Error:", error);
        });
    }

    function populateInstitutionDetails(institution) {
      const detailsContainer = document.getElementById("institutionDetails");
      detailsContainer.innerHTML = `
      <h2>${institution.university_name}</h2>
      <p><strong>State:</strong> ${institution.state}</p>
      <p><strong>Program Type:</strong> ${institution.program_type}</p>
      <h3>Courses</h3>
      <ul class="list-group">
        ${institution.courses
          .map(
            (course) => `
          <li class="list-group-item">
            <h5>${course.course_name}</h5>
            <p><strong>UTME Requirements:</strong> ${
              course.utme_requirements || "N/A"
            }</p>
            <p><strong>Direct Entry Requirements:</strong> ${
              course.direct_entry_requirements || "N/A"
            }</p>
          </li>
        `
          )
          .join("")}
      </ul>
    `;
    }

    function removeBookmark(bookmarkId, buttonElement) {
      if (confirm("Are you sure you want to remove this bookmark?")) {
        fetch(`/remove_bookmark/${bookmarkId}`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token() }}",
            "Content-Type": "application/json",
          },
          credentials: "same-origin",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const listItem = buttonElement.closest(".list-group-item");
              listItem.style.animation = "fadeOut 0.5s";
              setTimeout(() => {
                listItem.remove();
                if (
                  document.querySelectorAll(".list-group-item").length === 0
                ) {
                  document.getElementById("bookmarks").innerHTML =
                    '<p class="text-muted">No bookmarked institutions.</p>';
                }
              }, 500);
            } else {
              alert("Failed to remove bookmark: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred while removing the bookmark");
          });
      }
    }
  });
</script>
<style>
  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }
</style>
{% endblock %}
